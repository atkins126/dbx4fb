<?xml version="1.0" encoding="ISO-8859-1"?>

<project name="DBX Test Cases" default="build" basedir=".">

	<taskdef resource="net/sf/antcontrib/antlib.xml"/>
	
	<property environment="env" />
	<property name="program.conf" location="dbxfbTests.ini" />
	
	<target name="build">
		<echo message=" 1. DBX 4 Firebird driver for Delphi 2007" />
		<echo message=" 2. DBX 4 Firebird driver for Delphi 2009" />
		<echo message=" 3. DBX 4 Firebird driver for Delphi 2010" />
		<echo message=" 4. DBX 4 Firebird driver for Delphi XE" />
		<echo message=" 5. DBX 4 Firebird driver for Delphi XE2 Win32" />
		<echo message=" 6. DBX 4 Firebird driver for Delphi XE2 Win64" />
		<echo message=" 7. DBX 4 Firebird driver for Delphi XE3 Win32" />
		<echo message=" 8. DBX 4 Firebird driver for Delphi XE3 Win64" />
		<echo message=" 9. DBX 4 Firebird driver for Delphi XE4 Win32" />
		<echo message="10. DBX 4 Firebird driver for Delphi XE4 Win64" />
		<echo message="11. DBX 4 Firebird driver for Delphi XE5 Win32" />
		<echo message="12. DBX 4 Firebird driver for Delphi XE5 Win64" />
		<echo message="13. DBX 4 Firebird driver for Delphi XE6 Win32" />
		<echo message="14. DBX 4 Firebird driver for Delphi XE6 Win64" />
		<echo message="15. DBX 4 Firebird driver for Delphi XE7 Win32" />
		<echo message="16. DBX 4 Firebird driver for Delphi XE7 Win64" />
		<echo message="X. Exit" />
		<echo />
		<input message="Please choose option to ant:" validargs="1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,x,X" addproperty="p.option" defaultvalue="1" />

		<antcall target="t.execute"/>
	</target>

	<target name="dbx.test">
		<tempfile property="p.script" destdir="${env.TEMP}" suffix=".cmd"/>

		<condition property="p.config" value="" else="release">
			<equals arg1="${p.tag.program}" arg2="d11" />
		</condition>

		<condition property="p.suite" value="-suite ${suite}" else="">
			<isset property="suite" />
		</condition>

		<condition property="p.core_2978" value="-CORE_2978" else="">
			<isset property="CORE_2978" />
		</condition>

		<property name="program" location="${env.HOMEDRIVE}${env.HOMEPATH}\development\output.${p.tag.program}\moon\${p.platform}\${p.config}\dbxfbTests.exe" />

		<echo file="${p.script}">
			${program} -config ${program.conf} -drivers ${env.HOMEDRIVE}${env.HOMEPATH}\development\drivers -test ${test} ${p.suite} ${p.core_2978} -console
		</echo>

		<exec executable="cmd" spawn="false" failonerror="true">
			<arg line="/c ${p.script}" />
		</exec>

		<delete file="${p.script}" />
	</target>

	<target name="t.execute" depends="t.option,t.platform,t.platform.testcount" unless="p.option.exit">
		<for param="i" begin="1" end="${p.embedded_1.end}" parallel="true" threadCount="${env.NUMBER_OF_PROCESSORS}">
			<sequential>
				<antcall target="dbx.test">
					<param name="test" value="embedded_@{i}" />
					<param name="suite" value="1" />					
					<param name="CORE_2978" value="" />
				</antcall>
			</sequential>
		</for>

		<for param="i" begin="${p.embedded_2.begin}" end="${p.embedded_2.end}">
			<sequential>
				<antcall target="dbx.test">
					<param name="test" value="embedded_@{i}" />
					<param name="suite" value="1" />					
				</antcall>
			</sequential>
		</for>

		<for param="i" begin="1" end="${p.embedded_2.end}">
			<sequential>
				<antcall target="dbx.test">
					<param name="test" value="embedded_@{i}" />
					<param name="suite" value="2" />
				</antcall>
			</sequential>
		</for>

		<for param="i" begin="1" end="${p.server.count}" parallel="true" threadCount="${env.NUMBER_OF_PROCESSORS}">
			<sequential>
				<antcall target="dbx.test">
					<param name="test" value="server_@{i}" />
				</antcall>
			</sequential>
		</for>
	</target>

	<target name="t.option">
		<condition property="p.tag.program" value="d11">
			<equals arg1="${p.option}" arg2="1" />
		</condition>

		<condition property="p.tag.program" value="d12">
			<equals arg1="${p.option}" arg2="2" />
		</condition>

		<condition property="p.tag.program" value="d14">
			<equals arg1="${p.option}" arg2="3" />
		</condition>

		<condition property="p.tag.program" value="d15">
			<equals arg1="${p.option}" arg2="4" />
		</condition>

		<condition property="p.tag.program" value="d16">
			<or>
				<equals arg1="${p.option}" arg2="5" />
				<equals arg1="${p.option}" arg2="6" />
			</or>
		</condition>

		<condition property="p.tag.program" value="d17">
			<or>
				<equals arg1="${p.option}" arg2="7" />
				<equals arg1="${p.option}" arg2="8" />
			</or>
		</condition>

		<condition property="p.tag.program" value="d18">
			<or>
				<equals arg1="${p.option}" arg2="9" />
				<equals arg1="${p.option}" arg2="10" />
			</or>
		</condition>

		<condition property="p.tag.program" value="d19">
			<or>
				<equals arg1="${p.option}" arg2="11" />
				<equals arg1="${p.option}" arg2="12" />
			</or>
		</condition>

		<condition property="p.tag.program" value="d20">
			<or>
				<equals arg1="${p.option}" arg2="13" />
				<equals arg1="${p.option}" arg2="14" />
			</or>
		</condition>

		<condition property="p.tag.program" value="xe7">
			<or>
				<equals arg1="${p.option}" arg2="15" />
				<equals arg1="${p.option}" arg2="16" />
			</or>
		</condition>
		
		<condition property="p.option.exit">
			<or>
				<equals arg1="${p.option}" arg2="x" />
				<equals arg1="${p.option}" arg2="X" />
			</or>
		</condition>
	</target>
	
	<target name="t.platform">
		<condition property="p.platform" value="">
			<equals arg1="${p.option}" arg2="1" />
		</condition>
		
		<condition property="p.platform" value="Win32">
			<or>
				<equals arg1="${p.option}" arg2="2" />
				<equals arg1="${p.option}" arg2="3" />
				<equals arg1="${p.option}" arg2="4" />
				<equals arg1="${p.option}" arg2="5" />
				<equals arg1="${p.option}" arg2="7" />
				<equals arg1="${p.option}" arg2="9" />
				<equals arg1="${p.option}" arg2="11" />
				<equals arg1="${p.option}" arg2="13" />
				<equals arg1="${p.option}" arg2="15" />
			</or>
		</condition>
		
		<condition property="p.platform" value="Win64">
			<or>
				<equals arg1="${p.option}" arg2="6" />
				<equals arg1="${p.option}" arg2="8" />
				<equals arg1="${p.option}" arg2="10" />
				<equals arg1="${p.option}" arg2="12" />
				<equals arg1="${p.option}" arg2="14" />
				<equals arg1="${p.option}" arg2="16" />
			</or>
		</condition>
	</target>
	
	<target name="t.platform.testcount">
		<condition property="p.platform" value="">
			<equals arg1="${p.option}" arg2="1" />
		</condition>

		<condition property="p.embedded_1.end" value="21" else="6">
			<or>
				<equals arg1="${p.platform}" arg2="" />
				<equals arg1="${p.platform}" arg2="Win32" />
			</or>
		</condition>

		<condition property="p.embedded_2.begin" value="22" else="7">
			<or>
				<equals arg1="${p.platform}" arg2="" />
				<equals arg1="${p.platform}" arg2="Win32" />
			</or>
		</condition>

		<condition property="p.embedded_2.end" value="27" else="12">
			<or>
				<equals arg1="${p.platform}" arg2="" />
				<equals arg1="${p.platform}" arg2="Win32" />
			</or>
		</condition>

		<condition property="p.server.count" value="5" else="3">
			<or>
				<equals arg1="${p.platform}" arg2="" />
				<equals arg1="${p.platform}" arg2="Win32" />
			</or>
		</condition>
	</target>

</project>
